# Device Management Commands

The device command group provides functionality for managing and controlling IoT devices through MQTT.

## Commands

### 1. Send Command

Send command to node using TLV (Type-Length-Value) format.

```bash
rm-node device send-command [OPTIONS]

Options:
  --node-id TEXT        Node ID [required]
  --request-id TEXT     Unique request ID (generated if not provided)
  --role [1|2|4]       User role (1=admin, 2=primary, 4=secondary) [required]
  --command INTEGER     Command code [required]
                       Common codes:
                       - 0: Get pending
                       - 16: Request file upload
                       - 17: Get file download
                       - 20: Confirm upload
  --command-data TEXT   Optional command data as JSON string
  -h, --help           Show this help message

Examples:
  # Send a basic command
  rm-node device send-command --node-id node123 --role 1 --command 0

  # Send command with data
  rm-node device send-command --node-id node123 --role 1 --command 16 --command-data '{"filename":"config.json"}'

  # Send command as primary user
  mqtt-cli device send-command --node-id node123 --role 2 --command 0
```

## Command Response Format

When a command is sent successfully, you'll receive a response with the following details:

```
✓ Sent command to node <node-id>

Command Details:
----------------------------------------
Request ID: <auto-generated-or-provided-id>
Role: <role-number>
Command: <command-code>

Command Data:
{
  // JSON data if provided
}
----------------------------------------
```

## User Roles

The CLI supports three user roles for device commands:

1. Admin (role=1)
   - Full access to all commands
   - Can perform system-level operations
   - Typically used for maintenance and configuration

2. Primary User (role=2)
   - Access to device control commands
   - Can perform most device operations
   - Standard user role for device owners

3. Secondary User (role=4)
   - Limited access to device commands
   - Can perform basic operations
   - Typically used for shared device access

## Command Codes

Common command codes and their purposes:

| Code | Purpose | Description |
|------|---------|-------------|
| 0 | Get Pending | Check for pending operations |
| 16 | Request Upload | Request to upload a file |
| 17 | Get Download | Request file download |
| 20 | Confirm Upload | Confirm file upload completion |

## Best Practices

1. Always verify the connection before sending commands
2. Use appropriate role levels for commands
3. Include meaningful request IDs for tracking
4. Validate command data JSON before sending
5. Monitor command responses for success/failure
6. Use debug mode for troubleshooting command issues

## Error Handling

Common error scenarios and solutions:

1. Connection Errors
   ```bash
   ✗ Failed to connect
   # Solution: Verify node ID and connection settings
   ```

2. Invalid Command Data
   ```bash
   ✗ Invalid JSON in command data
   # Solution: Validate JSON format
   ```

3. Permission Errors
   ```bash
   ✗ Insufficient permissions
   # Solution: Use appropriate role level
   ```

## Command Flow

1. Connection Check
   - CLI verifies connection to node
   - Establishes connection if needed

2. Command Preparation
   - Generates request ID if not provided
   - Formats command data
   - Creates TLV message

3. Command Execution
   - Publishes to node topic
   - Waits for acknowledgment

4. Response Handling
   - Displays command details
   - Shows any response data
   - Reports success/failure 